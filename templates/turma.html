<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Turma {{ turma.nome }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/turma_prof.css') }}"
    />
  </head>
  <body class="p-4">
    <div
      class="topbar d-flex flex-wrap justify-content-between align-items-center mb-4"
    >
      <div class="topbar-left d-flex align-items-center gap-2">
        <a href="{{ url_for('dashboard') }}" class="btn btn-back">
          ← Voltar
        </a>
      </div>
      <h3 class="turma-title mb-0">{{ turma.nome }}</h3>
    </div>

    <!-- Abas -->
    <div class="tabs">
      <div class="tab active" data-tab="alunosTab">Alunos</div>
      <div class="tab" data-tab="materiaisTab">Materiais</div>
      <div class="tab" data-tab="avisosTab">Avisos / Mural</div>
      <div class="tab" data-tab="diarioTab">Diário de Classe</div>
    </div>

    <!-- Conteúdo das abas -->
    <div id="alunosTab" class="tab-content active">
      {% if alunos %}
      <!-- Adicionar Aluno -->
      <div class="card-tool p-3 mb-3">
        <h5>Adicionar Aluno</h5>
        <form
          id="addAlunoForm"
          method="POST"
          action="{{ url_for('adicionar_aluno') }}"
          class="position-relative"
        >
          <input type="hidden" name="turma" value="{{ turma.nome }}" />
          <div class="mb-2 position-relative">
            <input
              type="text"
              id="alunoBusca"
              class="form-control"
              placeholder="Digite o nome do aluno"
              autocomplete="off"
            />
            <div id="autocomplete-list" class="autocomplete-suggestions"></div>
          </div>
          <button type="submit" class="btn btn-success btn-sm">
            Adicionar
          </button>
        </form>
      </div>

      <div class="alunos-container">
        {% for aluno in alunos %}
        <div class="card-aluno">
          <div
            class="avatar {% if aluno.online %}status-online{% else %}status-offline{% endif %}"
          >
            {{ aluno.fullname[0]|upper }}
          </div>
          <strong>{{ aluno.fullname }}</strong>
          <p class="text-muted">{{ aluno.email }}</p>
          <form
            action="{{ url_for('remover_aluno') }}"
            method="POST"
            class="mt-2"
          >
            <input type="hidden" name="turma" value="{{ turma.nome }}" />
            <input type="hidden" name="aluno_email" value="{{ aluno.email }}" />
            <button type="submit" class="btn btn-danger btn-sm w-100">
              Remover
            </button>
          </form>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-muted">Nenhum aluno cadastrado nesta turma.</p>
      {% endif %}
    </div>

    <div id="materiaisTab" class="tab-content">
      <div class="card-tool p-3 mb-3">
        <h5>Enviar Material</h5>
        <form
          action="{{ url_for('upload_material') }}"
          method="POST"
          enctype="multipart/form-data"
        >
          <input type="hidden" name="turma" value="{{ turma.nome }}" />
          <div class="mb-2">
            <input type="file" name="arquivo" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary btn-sm">Enviar</button>
        </form>
      </div>
      <h5>Materiais Enviados</h5>
      {% if materiais %}
      <ul class="list-group">
        {% for mat in materiais %}
        <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          {{ mat.arquivo }}
          <a
            href="{{ url_for('static', filename='materiais/' + mat.arquivo) }}"
            class="btn btn-sm btn-outline-primary"
            target="_blank"
            >Abrir</a
          >
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted">Nenhum material enviado ainda.</p>
      {% endif %}
    </div>

    <div id="avisosTab" class="tab-content">
      <div class="card-tool mb-3">
        <h5>Mural de Avisos</h5>
        <form
          id="formAvisos"
          method="POST"
          action="{{ url_for('adicionar_aviso') }}"
        >
          <input type="hidden" name="turma" value="{{ turma.nome }}" />
          <div class="mb-2">
            <input
              type="text"
              class="form-control"
              name="titulo"
              placeholder="Título do aviso"
              required
            />
          </div>
          <div class="mb-2">
            <textarea
              class="form-control"
              name="mensagem"
              rows="3"
              placeholder="Mensagem do aviso"
              required
            ></textarea>
          </div>
          <button type="submit" class="btn btn-info btn-sm">Publicar</button>
        </form>
      </div>
      {% if avisos %}
      <ul class="list-group">
        {% for aviso in avisos %}
        <li class="list-group-item">
          <strong>{{ aviso.titulo }}</strong> -
          <span class="text-muted">{{ aviso.data }}</span>
          <p>{{ aviso.mensagem }}</p>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted">Nenhum aviso publicado ainda.</p>
      {% endif %}
    </div>

    <div id="diarioTab" class="tab-content">
      <h5>Diário de Classe</h5>
      <div class="card-tool mb-3">
        <form
          action="{{ url_for('diario_turma', nome=turma['nome']) }}"
          method="POST"
        >
          <label for="aula" class="">Aula:</label>
          <select name="aula" id="aula" required class="form-select">
            <option value="" disabled selected>Selecione a aula</option>
            {% for aula in aulas %}
            <option value="{{ aula }}">{{ aula }}</option>
            {% endfor %}
          </select>

          <label for="conteudo" class="">Conteúdo:</label>
          <textarea
            name="conteudo"
            id="conteudo"
            rows="4"
            required
            class="form-textarea"
          ></textarea>

          <button type="submit" class="btn btn-primary">
            Adicionar Registro
          </button>
        </form>
      </div>

      {% if registros %}
      <ul class="list-group">
        {% for reg in registros %}
        <li
          class="list-group-item d-flex justify-content-between align-items-start"
        >
          <div>
            <strong>Aula: {{ reg.aula }}</strong> -
            <span class="text-muted">{{ reg.data }}</span>
            <p>{{ reg.conteudo }}</p>
          </div>
          <button
            class="btn btn-sm btn-outline-primary edit-btn"
            data-id="{{ reg.id }}"
            data-aula="{{ reg.aula }}"
            data-conteudo="{{ reg.conteudo }}"
            data-bs-toggle="modal"
            data-bs-target="#editModal"
          >
            Editar
          </button>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted">Nenhum registro no diário ainda.</p>
      {% endif %}
    </div>

    <!-- Modal de edição puro -->
    <div id="editModal" class="custom-modal">
      <div class="custom-modal-content">
        <span class="custom-modal-close">&times;</span>
        <h5>Editar Registro do Diário</h5>
        <form id="editForm" method="POST">
          <div class="form-group">
            <label for="editAula">Aula</label>
            <select name="aula" id="editAula" required class="form-select">
              <option value="" disabled>Selecione a aula</option>
              {% for aula in aulas %}
              <option value="{{ aula }}">{{ aula }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="editConteudo">Conteúdo</label>
            <textarea
              name="conteudo"
              id="editConteudo"
              rows="4"
              required
              class="form-textarea"
            ></textarea>
          </div>
          <div class="modal-buttons">
            <button type="button" class="btn btn-cancel">Cancelar</button>
            <button type="submit" class="btn btn-save">
              Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Sistema de abas
      const tabs = document.querySelectorAll(".tab");
      const contents = document.querySelectorAll(".tab-content");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          contents.forEach((c) => c.classList.remove("active"));
          tab.classList.add("active");
          document.getElementById(tab.dataset.tab).classList.add("active");
        });
      });

      // Autocomplete de alunos
      const alunoInput = document.getElementById("alunoBusca");
      const alunoSelect = document.getElementById("alunoSelect");
      const autocompleteList = document.getElementById("autocomplete-list");

      alunoInput.addEventListener("input", async () => {
        const termo = alunoInput.value.trim();
        if (!termo) {
          autocompleteList.innerHTML = "";
          return;
        }

        const res = await fetch(
          `/buscar_alunos?q=${encodeURIComponent(termo)}`
        );
        const data = await res.json();

        autocompleteList.innerHTML = "";
        data.forEach((aluno) => {
          const div = document.createElement("div");
          div.textContent = aluno.fullname + " (" + aluno.email + ")";
          div.classList.add("autocomplete-suggestion");
          div.addEventListener("click", () => {
            alunoInput.value = aluno.fullname;
            alunoSelect.innerHTML = `<option value="${aluno.email}" selected>${aluno.fullname} (${aluno.email})</option>`;
            autocompleteList.innerHTML = "";
          });
          autocompleteList.appendChild(div);
        });
      });

      document.addEventListener("click", (e) => {
        if (!alunoInput.contains(e.target)) autocompleteList.innerHTML = "";
      });

      // Seleciona elementos
      const editModal = document.getElementById("editModal");
      const editForm = document.getElementById("editForm");
      const editAula = document.getElementById("editAula");
      const editConteudo = document.getElementById("editConteudo");
      const closeBtn = document.querySelector(".custom-modal-close");
      const cancelBtn = document.querySelector(".btn-cancel");

      // Função para abrir modal com dados
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const aula = btn.dataset.aula;
          const conteudo = btn.dataset.conteudo;

          // Atualiza action do form
          editForm.action = `/turma/{{ turma.nome }}/diario/editar/${id}`;
          editAula.value = aula;
          editConteudo.value = conteudo;

          // Mostra modal
          editModal.style.display = "block";
        });
      });

      // Fechar modal ao clicar no X ou no cancelar
      closeBtn.onclick = () => (editModal.style.display = "none");
      cancelBtn.onclick = () => (editModal.style.display = "none");

      // Fechar modal clicando fora do conteúdo
      window.onclick = function (event) {
        if (event.target == editModal) {
          editModal.style.display = "none";
        }
      };

      // Trim do conteúdo antes de enviar
      editForm.addEventListener("submit", () => {
        editConteudo.value = editConteudo.value.trim();
      });
    </script>
  </body>
</html>
