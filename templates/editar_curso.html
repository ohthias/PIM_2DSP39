{% extends "dashboard_admin.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Editando: {{ curso.nome }}</h2>
  <form method="POST" id="form-editar-curso">
    {% for periodo, materias in curso.materias.items() %}
    <div class="card mb-3">
      <div class="card-header">Período {{ periodo }}</div>
      <div class="card-body">
        <div id="materias_{{ periodo }}">
          {% for m in materias %}
          <div class="input-group mb-2">
            <input type="text" name="materias_{{ periodo }}[]" class="form-control materia-input"
                   placeholder="Nome da matéria" value="{{ m.nome if m is mapping else m }}">
            <input type="number" name="aulas_{{ periodo }}[]" class="form-control"
                   placeholder="Qtd. aulas" min="1" value="{{ m.aulas if m is mapping else '' }}">
          </div>
          {% endfor %}
          <div class="input-group mb-2">
            <input type="text" name="materias_{{ periodo }}[]" class="form-control materia-input"
                   placeholder="Nova matéria...">
            <input type="number" name="aulas_{{ periodo }}[]" class="form-control"
                   placeholder="Qtd. aulas" min="1">
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-success">Salvar Alterações</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Função para adicionar campo de matéria dinamicamente
  function addNovaMateria(input) {
    const container = input.closest(".card-body").querySelector("div[id^='materias_']");
    const ultimaLinha = container.lastElementChild;
    const novoGrupo = ultimaLinha.cloneNode(true);

    // Limpa valores dos novos campos
    novoGrupo.querySelectorAll("input").forEach(inp => inp.value = "");

    container.appendChild(novoGrupo);

    // Reatribui o listener ao novo input
    novoGrupo.querySelector(".materia-input").addEventListener("input", handleMateriaInput);
  }

  // Listener que detecta se o campo foi preenchido
  function handleMateriaInput(event) {
    const input = event.target;
    const container = input.closest("div[id^='materias_']");
    const inputs = container.querySelectorAll(".materia-input");
    const ultimo = inputs[inputs.length - 1];

    if (input === ultimo && input.value.trim() !== "") {
      addNovaMateria(input);
    }
  }

  // Ativa o evento para todos os inputs existentes
  document.querySelectorAll(".materia-input").forEach(input => {
    input.addEventListener("input", handleMateriaInput);
  });
});
</script>
{% endblock %}
